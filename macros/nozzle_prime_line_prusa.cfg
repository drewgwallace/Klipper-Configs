[gcode_macro NOZZLE_PRIME_LINE]
description:
  Prime the nozzle by laying a strip of plastic along the bottom side of the bed
gcode:  
  SAVE_GCODE_STATE NAME=nozzle_prime_state
  {% set x_start = params.X|default(60)|float %}
  {% set x_end = x_start + params.x_distance|default(120)|float %}
  {% set y_start = params.Y|default(0)|float - 3 %}
  {% set y_end = y_start %}
  {% if x_end > printer.toolhead.axis_maximum.x - 5 %}
    {% set x_end = printer.toolhead.axis_maximum.y - 5 %}
  {% endif %}
  printer.configfile.config.extruder.nozzle_diameter
						printer.configfile.settings.extruder.nozzle_diameter : 0.8
  {% set nozzle_diam = printer.configfile.settings.extruder.nozzle_diameter %}
  {% set filament_diam = printer.configfile.settings.extruder.filament_diameter %}
  {% set retract_len = printer.configfile.settings.firmware_retraction.retract_length %}
  {% set pi = 3.1415926536 %}
  {% set layer_height = 0.28 %}
  {% set line_width = nozzle_diam * 1.75 %}
  {% set x_diff = x_end - x_start %}
  {% set extrude_cross_section_area = (pi * ((layer_height / 2) ** 2)) + ((line_width - layer_height) * layer_height) %}
  {% set extrude_vol = y_diff * extrude_cross_section_area %}
  {% set extrude_len = (extrude_vol * 1.75) / (pi * (filament_diam / 2) ** 2) %}
  { action_respond_info("retract_len: %i " % retract_len|int) }
  { action_respond_info("filament_diam: %i " % filament_diam|int) }
  { action_respond_info("nozzle_diam: %i " % nozzle_diam|int) }
  { action_respond_info("x_diff: %i " % y_diff|int) }
  { action_respond_info("extrude_cross_section_area: %i " % extrude_cross_section_area|int) }
  { action_respond_info("extrude_vol: %i " % extrude_vol|int) }
  { action_respond_info("extrude_len: %i " % extrude_len|int) }

  G1 Z0.3 F720
  G1 Y{y_start} F1000 								# go outside print area
  G92 E0
  G1 X{x_start} E{extrude_len|int} F1000 							# intro line
  G1 X{x_end} E{extrude_len * 2|int} F1000 								# intro line
  G1 Z5.0 E{(extrude_len * 2) - retract_len|int} F3000 ;Move Z axis up & retract
  G92 E0

  RESTORE_GCODE_STATE NAME=nozzle_prime_state
